{"ast":null,"code":"import _objectSpread from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/regenerator\";import _objectWithoutProperties from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _asyncToGenerator from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";var _excluded=[\"basket\"],_excluded2=[\"basket\"];import{createAsyncThunk,createSlice,isAnyOf}from'@reduxjs/toolkit';import agent from'../../app/api/agent';import{history}from'../..';import{toast}from'react-toastify';import{setBasket}from'../basket/basketSlice';var initialState={user:null};export var SingInUser=createAsyncThunk('account/SingInUser',/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data,thunkAPI){var userDto,basket,user;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return agent.Account.login(data);case 3:userDto=_context.sent;basket=userDto.basket,user=_objectWithoutProperties(userDto,_excluded);if(basket)thunkAPI.dispatch(setBasket(basket));localStorage.setItem('user',JSON.stringify(user));return _context.abrupt(\"return\",user);case 10:_context.prev=10;_context.t0=_context[\"catch\"](0);return _context.abrupt(\"return\",thunkAPI.rejectWithValue({error:_context.t0.data}));case 13:case\"end\":return _context.stop();}}},_callee,null,[[0,10]]);}));return function(_x,_x2){return _ref.apply(this,arguments);};}());export var fetchCurrentUser=createAsyncThunk('account/fetchCurrentUser',/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_,thunkAPI){var userDto,basket,user;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:thunkAPI.dispatch(setUser(JSON.parse(localStorage.getItem('user'))));_context2.prev=1;_context2.next=4;return agent.Account.currentUser();case 4:userDto=_context2.sent;basket=userDto.basket,user=_objectWithoutProperties(userDto,_excluded2);if(basket)thunkAPI.dispatch(setBasket(basket));localStorage.setItem('user',JSON.stringify(user));return _context2.abrupt(\"return\",user);case 11:_context2.prev=11;_context2.t0=_context2[\"catch\"](1);return _context2.abrupt(\"return\",thunkAPI.rejectWithValue({error:_context2.t0.data}));case 14:case\"end\":return _context2.stop();}}},_callee2,null,[[1,11]]);}));return function(_x3,_x4){return _ref2.apply(this,arguments);};}(),{condition:function condition(){if(!localStorage.getItem('user'))return false;}});var accountSlice=createSlice({name:'account',initialState:initialState,reducers:{signOut:function signOut(state){state.user=null;localStorage.removeItem('user');history.push('../');},setUser:function setUser(state,action){var claims=JSON.parse(atob(action.payload.token.split('.')[1]));var roles=claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];state.user=_objectSpread(_objectSpread({},action.payload),{},{roles:typeof roles==='string'?[roles]:roles});}},extraReducers:function extraReducers(builder){builder.addCase(fetchCurrentUser.rejected,function(state){state.user=null;localStorage.removeItem('user');toast.error('Session Expired ! please login again');history.push('../');});builder.addMatcher(isAnyOf(SingInUser.fulfilled,fetchCurrentUser.fulfilled),function(state,action){var claims=JSON.parse(atob(action.payload.token.split('.')[1]));var roles=claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];state.user=_objectSpread(_objectSpread({},action.payload),{},{roles:typeof roles==='string'?[roles]:roles});});builder.addMatcher(isAnyOf(SingInUser.rejected),function(state,action){console.log(action.payload);});}});var _accountSlice$actions=accountSlice.actions,signOut=_accountSlice$actions.signOut,setUser=_accountSlice$actions.setUser;export{signOut,setUser};export default accountSlice.reducer;","map":{"version":3,"sources":["D:/Learn/react/SouqApp/SPA/src/features/account/accountSlice.ts"],"names":["createAsyncThunk","createSlice","isAnyOf","agent","history","toast","setBasket","initialState","user","SingInUser","data","thunkAPI","Account","login","userDto","basket","dispatch","localStorage","setItem","JSON","stringify","rejectWithValue","error","fetchCurrentUser","_","setUser","parse","getItem","currentUser","condition","accountSlice","name","reducers","signOut","state","removeItem","push","action","claims","atob","payload","token","split","roles","extraReducers","builder","addCase","rejected","addMatcher","fulfilled","console","log","actions","reducer"],"mappings":"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","sourcesContent":["import { createAsyncThunk, createSlice, isAnyOf } from '@reduxjs/toolkit'\r\nimport { User } from '../../app/models/user';\r\nimport { FieldValues } from 'react-hook-form';\r\nimport agent from '../../app/api/agent';\r\nimport { history } from '../..';\r\nimport { toast } from 'react-toastify';\r\nimport { setBasket } from '../basket/basketSlice';\r\n\r\ninterface AccountState{\r\n    user:User | null\r\n\r\n\r\n\r\n}\r\n\r\nconst initialState :AccountState= {\r\n    user:null\r\n\r\n}\r\n\r\nexport const SingInUser=createAsyncThunk<User,FieldValues>(\r\n    'account/SingInUser',\r\n    async(data,thunkAPI)=>{\r\n        try {\r\n            const userDto = await agent.Account.login(data);\r\n            const {basket,...user}=userDto;\r\n            if(basket)thunkAPI.dispatch(setBasket(basket));\r\n            localStorage.setItem('user',JSON.stringify(user))\r\n            return user;\r\n        } catch (error:any) {\r\n            return thunkAPI.rejectWithValue({error:error.data})\r\n\r\n        \r\n        }\r\n\r\n\r\n    }\r\n\r\n\r\n)\r\n\r\nexport const fetchCurrentUser=createAsyncThunk<User>(\r\n    'account/fetchCurrentUser',\r\n    async(_,thunkAPI)=>{\r\n\r\n        thunkAPI.dispatch(setUser(JSON.parse(localStorage.getItem('user')!)))\r\n        try {\r\n            const userDto = await agent.Account.currentUser();\r\n            const {basket,...user}=userDto;\r\n            if(basket)thunkAPI.dispatch(setBasket(basket));\r\n            localStorage.setItem('user',JSON.stringify(user))\r\n            return user;\r\n        } catch (error:any) {\r\n            return thunkAPI.rejectWithValue({error:error.data})\r\n\r\n        \r\n        }\r\n\r\n\r\n    },{\r\n        condition:()=>{\r\n            if(!localStorage.getItem('user'))return false;\r\n        }\r\n    }\r\n\r\n\r\n)\r\n\r\n\r\n\r\n\r\nconst accountSlice = createSlice({\r\n  name: 'account',\r\n  initialState,\r\n  reducers: {\r\n    signOut:(state)=>{\r\n        state.user=null;\r\n        localStorage.removeItem('user');\r\n        history.push('../')\r\n    },\r\n    setUser:(state,action)=>{\r\n        let claims=JSON.parse(atob(action.payload.token.split('.')[1]));\r\n        let roles=claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];\r\n\r\n        state.user={...action.payload,roles:typeof(roles)==='string'?[roles]:roles};\r\n        \r\n    }\r\n  },\r\n  extraReducers:(builder =>{\r\n\r\n    builder.addCase(fetchCurrentUser.rejected,(state)=>{\r\n\r\n        state.user=null;\r\n        localStorage.removeItem('user');\r\n        toast.error('Session Expired ! please login again');\r\n        history.push('../')\r\n\r\n\r\n    });\r\n    builder.addMatcher(isAnyOf(SingInUser.fulfilled,fetchCurrentUser.fulfilled),\r\n    (state,action)=>{\r\n\r\n        let claims=JSON.parse(atob(action.payload.token.split('.')[1]));\r\n        let roles=claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];\r\n\r\n        state.user={...action.payload,roles:typeof(roles)==='string'?[roles]:roles};\r\n    });\r\n    builder.addMatcher(isAnyOf(SingInUser.rejected),\r\n    (state,action)=>{\r\n\r\n        console.log(action.payload) ;\r\n    });\r\n\r\n    \r\n\r\n  })\r\n  \r\n});\r\n\r\nexport const {signOut,setUser} = accountSlice.actions\r\n\r\nexport default accountSlice.reducer"]},"metadata":{},"sourceType":"module"}