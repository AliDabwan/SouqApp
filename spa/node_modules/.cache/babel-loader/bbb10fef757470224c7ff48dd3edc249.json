{"ast":null,"code":"import _objectWithoutProperties from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _regeneratorRuntime from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _defineProperty from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"D:/Learn/react/SouqApp/spa/node_modules/@babel/runtime/helpers/esm/slicedToArray\";var _excluded=[\"nameOnCard\",\"saveAddress\"];import{Paper,Typography,Stepper,Step,StepLabel,Box,Button,Container}from\"@mui/material\";import{useEffect,useState}from\"react\";import AddressForm from\"./AddressForm\";import PaymentForm from\"./PaymentForm\";import Review from\"./Review\";import{FormProvider,useForm}from\"react-hook-form\";import{yupResolver}from\"@hookform/resolvers/yup\";import{validationSchema}from\"./checkoutValidation\";import{useAppDispatch,useAppSelector}from\"../../app/store/configureStore\";import agent from\"../../app/api/agent\";import{clearBasket}from\"../basket/basketSlice\";import{LoadingButton}from\"@mui/lab\";import{useStripe,useElements,CardNumberElement}from\"@stripe/react-stripe-js\";import{history}from\"../..\";import{toast}from\"react-toastify\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var steps=['Shipping address','Review your order','Payment details'];export default function CheckoutPage(){var _useState=useState(0),_useState2=_slicedToArray(_useState,2),activeStep=_useState2[0],setActiveStep=_useState2[1];var _useAppSelector=useAppSelector(function(state){return state.basket;}),basket=_useAppSelector.basket;var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),orderNumber=_useState4[0],setOrderNumber=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),loading=_useState6[0],setLoading=_useState6[1];var dispatch=useAppDispatch();var _useState7=useState({elementError:{}}),_useState8=_slicedToArray(_useState7,2),cardState=_useState8[0],setCardState=_useState8[1];var _useState9=useState({cardNumber:false,cardExpiry:false,cardCvc:false}),_useState10=_slicedToArray(_useState9,2),cardComplete=_useState10[0],setCardComplete=_useState10[1];var _useState11=useState(''),_useState12=_slicedToArray(_useState11,2),paymentMessage=_useState12[0],setPaymentMessage=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),paymentSucceeded=_useState14[0],setPaymentSucceeded=_useState14[1];var stripe=useStripe();var elements=useElements();var onCardInputChange=function onCardInputChange(event){var _event$error;setCardState(_objectSpread(_objectSpread({},cardState),{},{elementError:_objectSpread(_objectSpread({},cardState.elementError),{},_defineProperty({},event.elementType,(_event$error=event.error)===null||_event$error===void 0?void 0:_event$error.message))}));setCardComplete(_objectSpread(_objectSpread({},cardComplete),{},_defineProperty({},event.elementType,event.complete)));};var getStepContent=function getStepContent(step){switch(step){case 0:return/*#__PURE__*/_jsx(AddressForm,{});case 1:return/*#__PURE__*/_jsx(Review,{});case 2:return/*#__PURE__*/_jsx(PaymentForm,{cardState:cardState,onCardInputChange:onCardInputChange});default:throw new Error('Unknown step');}};var currentValidatoinSchema=validationSchema[activeStep];var methods=useForm({mode:'all',resolver:yupResolver(currentValidatoinSchema)});// use form hook\nuseEffect(function(){agent.Account.fetchAddress().then(function(response){if(response){methods.reset(_objectSpread(_objectSpread(_objectSpread({},methods.getValues()),response),{},{saveAddress:false}));}});},[methods]);var handleNext=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(activeStep===steps.length-1)){_context.next=5;break;}_context.next=3;return submitOrder(data);case 3:_context.next=6;break;case 5:setActiveStep(activeStep+1);case 6:case\"end\":return _context.stop();}}},_callee);}));return function handleNext(_x){return _ref.apply(this,arguments);};}();var handleBack=function handleBack(){setActiveStep(activeStep-1);};var submitOrder=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(data){var nameOnCard,saveAddress,shippingAddress,_paymentResult$paymen,cardElement,paymentResult,_orderNumber,_paymentResult$error;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:toast.error(methods.formState.isValid);setLoading(true);nameOnCard=data.nameOnCard,saveAddress=data.saveAddress,shippingAddress=_objectWithoutProperties(data,_excluded);if(!(!stripe||!elements)){_context2.next=5;break;}return _context2.abrupt(\"return\");case 5:_context2.prev=5;cardElement=elements.getElement(CardNumberElement);_context2.next=9;return stripe.confirmCardPayment(basket===null||basket===void 0?void 0:basket.clientSecret,{payment_method:{card:cardElement,billing_details:{name:nameOnCard}}});case 9:paymentResult=_context2.sent;if(!(((_paymentResult$paymen=paymentResult.paymentIntent)===null||_paymentResult$paymen===void 0?void 0:_paymentResult$paymen.status)==='succeeded')){_context2.next=22;break;}_context2.next=13;return agent.Orders.create({saveAddress:saveAddress,shippingAddress:shippingAddress});case 13:_orderNumber=_context2.sent;setOrderNumber(_orderNumber);setPaymentSucceeded(true);setPaymentMessage('Thank you - we have received your payment');setActiveStep(activeStep+1);dispatch(clearBasket());setLoading(false);_context2.next=26;break;case 22:setPaymentMessage((_paymentResult$error=paymentResult.error)===null||_paymentResult$error===void 0?void 0:_paymentResult$error.message);setPaymentSucceeded(false);setLoading(false);setActiveStep(activeStep+1);case 26:_context2.next=32;break;case 28:_context2.prev=28;_context2.t0=_context2[\"catch\"](5);console.log(_context2.t0);setLoading(false);case 32:case\"end\":return _context2.stop();}}},_callee2,null,[[5,28]]);}));return function submitOrder(_x2){return _ref2.apply(this,arguments);};}();// if(!basket||basket.items.length===0)return <Navigate to=\"../\" />\nvar submitDisable=function submitDisable(){if(activeStep===steps.length-1){return!cardComplete.cardNumber||!cardComplete.cardExpiry||!cardComplete.cardCvc||!methods.formState.isValid;}else{return!methods.formState.isValid;}};return/*#__PURE__*/_jsx(FormProvider,_objectSpread(_objectSpread({},methods),{},{children:/*#__PURE__*/_jsx(Container,{maxWidth:\"lg\",children:/*#__PURE__*/_jsxs(Paper,{variant:\"outlined\",sx:{mt:10,p:{xs:2,md:3}},children:[/*#__PURE__*/_jsx(Typography,{component:\"h1\",variant:\"h4\",align:\"center\",children:\"Checkout\"}),/*#__PURE__*/_jsx(Stepper,{activeStep:activeStep,sx:{pt:3,pb:5},children:steps.map(function(label){return/*#__PURE__*/_jsx(Step,{children:/*#__PURE__*/_jsx(StepLabel,{children:label})},label);})}),/*#__PURE__*/_jsx(_Fragment,{children:activeStep===steps.length?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h5\",gutterBottom:true,children:paymentMessage}),paymentSucceeded?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Typography,{gutterBottom:true,variant:\"subtitle1\",children:[\"Your order number is #\",orderNumber,\". We have emailed your order confirmation, and will send you an update when your order has shipped.\"]}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:function onClick(){history.push('../');},children:\"Go Home\"})]}):/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:handleBack,children:\"Go back and try again\"})]}):/*#__PURE__*/_jsxs(\"form\",{onSubmit:methods.handleSubmit(handleNext),children:[getStepContent(activeStep),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',justifyContent:'flex-end'},children:[activeStep!==0&&/*#__PURE__*/_jsx(Button,{onClick:handleBack,sx:{mt:3,ml:1},children:\"Back\"}),/*#__PURE__*/_jsx(LoadingButton,{loading:loading,disabled:submitDisable(),variant:\"contained\",type:\"submit\",sx:{mt:3,ml:1},children:activeStep===steps.length-1?'Place order':'Next'})]})]})})]})})}));}","map":{"version":3,"sources":["D:/Learn/react/SouqApp/spa/src/features/checkout/CheckoutPage.tsx"],"names":["Paper","Typography","Stepper","Step","StepLabel","Box","Button","Container","useEffect","useState","AddressForm","PaymentForm","Review","FormProvider","useForm","yupResolver","validationSchema","useAppDispatch","useAppSelector","agent","clearBasket","LoadingButton","useStripe","useElements","CardNumberElement","history","toast","steps","CheckoutPage","activeStep","setActiveStep","state","basket","orderNumber","setOrderNumber","loading","setLoading","dispatch","elementError","cardState","setCardState","cardNumber","cardExpiry","cardCvc","cardComplete","setCardComplete","paymentMessage","setPaymentMessage","paymentSucceeded","setPaymentSucceeded","stripe","elements","onCardInputChange","event","elementType","error","message","complete","getStepContent","step","Error","currentValidatoinSchema","methods","mode","resolver","Account","fetchAddress","then","response","reset","getValues","saveAddress","handleNext","data","length","submitOrder","handleBack","formState","isValid","nameOnCard","shippingAddress","cardElement","getElement","confirmCardPayment","clientSecret","payment_method","card","billing_details","name","paymentResult","paymentIntent","status","Orders","create","console","log","submitDisable","mt","p","xs","md","pt","pb","map","label","push","handleSubmit","display","justifyContent","ml"],"mappings":"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","sourcesContent":["\r\nimport { Paper, Typography, Stepper, Step, StepLabel, Box, Button, Container } from \"@mui/material\";\r\nimport { useEffect, useState } from \"react\";\r\nimport AddressForm from \"./AddressForm\";\r\nimport PaymentForm from \"./PaymentForm\";\r\nimport Review from \"./Review\";\r\nimport { FieldValues, FormProvider, useForm } from \"react-hook-form\";\r\nimport { yupResolver } from \"@hookform/resolvers/yup\"\r\nimport { validationSchema } from \"./checkoutValidation\";\r\nimport { useAppDispatch, useAppSelector } from \"../../app/store/configureStore\";\r\nimport agent from \"../../app/api/agent\";\r\nimport { clearBasket } from \"../basket/basketSlice\";\r\nimport { LoadingButton } from \"@mui/lab\";\r\nimport { StripeElementType } from \"@stripe/stripe-js\";\r\nimport { useStripe, useElements, CardNumberElement } from \"@stripe/react-stripe-js\";\r\nimport {history} from \"../..\"\r\nimport { toast } from \"react-toastify\";\r\n\r\nconst steps = ['Shipping address', 'Review your order', 'Payment details'];\r\n\r\n\r\n\r\nexport default function CheckoutPage() {\r\n  \r\n\r\n    const [activeStep, setActiveStep] = useState(0);\r\n    const {basket}=useAppSelector(state=>state.basket);\r\n\r\n    const [orderNumber, setOrderNumber] = useState(0);\r\n    const [loading, setLoading] = useState(false);\r\n    const dispatch=useAppDispatch();\r\n\r\n    const [cardState,setCardState]=useState<{elementError:{[key in StripeElementType]?:string}}>({elementError:{}});\r\n  \r\n    const [cardComplete,setCardComplete]=useState<any>({cardNumber:false,cardExpiry:false,cardCvc:false});\r\n\r\n\r\n    const [paymentMessage, setPaymentMessage] = useState('');\r\n    const [paymentSucceeded, setPaymentSucceeded] = useState(false);\r\n    const stripe = useStripe();\r\n    const elements = useElements();\r\n\r\n    \r\n    const onCardInputChange=(event :any)=>{\r\n        setCardState({\r\n            ...cardState,\r\n            elementError:{\r\n                ...cardState.elementError,\r\n                [event.elementType]:event.error?.message\r\n            }\r\n        });\r\n        setCardComplete({...cardComplete,[event.elementType]:event.complete})\r\n    }\r\n\r\n\r\n    const getStepContent=(step: number)=> {\r\n        switch (step) {\r\n            case 0:\r\n                return <AddressForm />;\r\n            case 1: \r\n                return <Review />;\r\n            case 2:\r\n                return <PaymentForm cardState={cardState} onCardInputChange={onCardInputChange}  />;\r\n            default:\r\n                throw new Error('Unknown step');\r\n        }\r\n    }\r\n    const currentValidatoinSchema=validationSchema[activeStep];\r\n\r\n    const methods=useForm({\r\n\r\n        mode:'all',\r\n        resolver:yupResolver<any>(currentValidatoinSchema)\r\n            });// use form hook\r\n\r\n\r\n            useEffect(() => {\r\n             \r\n                agent.Account.fetchAddress()\r\n                .then(response=>{\r\n                    if(response){\r\n                        methods.reset({...methods.getValues(),...response,saveAddress:false})\r\n                    }\r\n                })\r\n            }, [methods])\r\n            \r\n\r\n    const handleNext = async (data:FieldValues) => {\r\n\r\n        // const {nameOnCard,saveAddress,...shippingAddress}=data;\r\n      if(activeStep===steps.length-1){\r\n\r\n        // setLoading(true);\r\n        // try {\r\n        //     console.log(data);\r\n\r\n        //     const orderNumber =await agent.Orders.create({saveAddress,shippingAddress});\r\n        //     setOrderNumber(orderNumber);\r\n        //     setActiveStep(activeStep+1);\r\n        //     setLoading(false);\r\n        //     setTimeout(() => {\r\n        //         dispatch(clearBasket());\r\n        //     }, 3000);\r\n\r\n\r\n\r\n        // } catch (error) {\r\n        //     console.log(error);\r\n\r\n        //     setLoading(false);\r\n\r\n        // }\r\n\r\n        await submitOrder(data);\r\n\r\n\r\n\r\n\r\n\r\n\r\n      }else\r\n      {\r\n        setActiveStep(activeStep + 1);\r\n\r\n\r\n      }\r\n    };\r\n\r\n    const handleBack = () => {\r\n        setActiveStep(activeStep - 1);\r\n    };\r\n\r\n    const submitOrder = async (data: FieldValues) => {\r\n        toast.error(methods.formState.isValid);\r\n        \r\n        setLoading(true);\r\n        const { nameOnCard, saveAddress, ...shippingAddress } = data;\r\n        if (!stripe || !elements) return; // stripe not ready\r\n        try {\r\n            const cardElement = elements.getElement(CardNumberElement);\r\n            const paymentResult = await stripe.confirmCardPayment(basket?.clientSecret!, {\r\n                payment_method: {\r\n                    card: cardElement!,\r\n                    billing_details: {\r\n                        name: nameOnCard\r\n                    }\r\n                }\r\n            });  \r\n        \r\n            if (paymentResult.paymentIntent?.status === 'succeeded') {\r\n                const orderNumber = await agent.Orders.create({ saveAddress, shippingAddress });\r\n                setOrderNumber(orderNumber);\r\n                setPaymentSucceeded(true);\r\n                setPaymentMessage('Thank you - we have received your payment');\r\n                setActiveStep(activeStep + 1);\r\n                dispatch(clearBasket());\r\n                setLoading(false);\r\n            } else {\r\n                setPaymentMessage(paymentResult.error?.message!);\r\n                setPaymentSucceeded(false);\r\n                setLoading(false);\r\n                setActiveStep(activeStep + 1);\r\n            }\r\n        } catch (error) {\r\n            console.log(error);\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n        // if(!basket||basket.items.length===0)return <Navigate to=\"../\" />\r\n\r\n\r\n\r\n        const submitDisable=():boolean=>{\r\n            if(activeStep===steps.length-1){\r\n                return !cardComplete.cardNumber||\r\n                !cardComplete.cardExpiry||\r\n                !cardComplete.cardCvc||\r\n                !methods.formState.isValid\r\n\r\n            }else\r\n            {\r\n                return  !methods.formState.isValid\r\n            }\r\n\r\n        }\r\n   \r\n\r\n    return (\r\n\r\n      \r\n        <FormProvider {...methods} > \r\n                <Container maxWidth=\"lg\"> \r\n            <Paper variant=\"outlined\" sx={{ mt: 10, p: { xs: 2, md: 3 } }}>\r\n                <Typography component=\"h1\" variant=\"h4\" align=\"center\">\r\n                    Checkout\r\n                </Typography>\r\n                <Stepper activeStep={activeStep} sx={{ pt: 3, pb: 5 }}>\r\n                    {steps.map((label) => (\r\n                        <Step key={label}>\r\n                            <StepLabel>{label}</StepLabel>\r\n                        </Step>\r\n                    ))}\r\n                </Stepper> \r\n                <>\r\n                    {activeStep === steps.length ? (\r\n                        \r\n                        <>\r\n                                <Typography variant=\"h5\" gutterBottom>\r\n                                    {paymentMessage}\r\n                                </Typography>\r\n                                {paymentSucceeded ? (\r\n                                    <>\r\n                                        <Typography gutterBottom variant=\"subtitle1\">\r\n                                            Your order number is #{orderNumber}. We have emailed your order\r\n                                            confirmation, and will send you an update when your order has\r\n                                            shipped.\r\n                                        </Typography>\r\n                                        <Button variant='contained' onClick={() => {\r\n                                            history.push('../')\r\n                                        }}>\r\n                                            Go Home\r\n                                        </Button>\r\n                                    </>\r\n                                ) : (\r\n                                    <Button variant='contained' onClick={handleBack}>\r\n                                        Go back and try again\r\n                                    </Button>\r\n                                )}\r\n                            </>\r\n\r\n\r\n                    ) : (\r\n                        <form  onSubmit={methods.handleSubmit(handleNext)}>\r\n                            {getStepContent(activeStep)}\r\n                            <Box sx={{ display: 'flex', justifyContent: 'flex-end' }}>\r\n                                {activeStep !== 0 && (\r\n                                    <Button onClick={handleBack} sx={{ mt: 3, ml: 1 }}>\r\n                                        Back\r\n                                    </Button>\r\n                                )}\r\n                                <LoadingButton\r\n                                loading={loading}\r\n                                    disabled={submitDisable()}\r\n\r\n                                    variant=\"contained\"\r\n                                   type=\"submit\"\r\n                                    sx={{ mt: 3, ml: 1 }}\r\n                                >\r\n                                    {activeStep === steps.length - 1 ? 'Place order' : 'Next'}\r\n                                </LoadingButton>\r\n                            </Box>\r\n                        </form>\r\n                    )}\r\n                </>\r\n            </Paper> \r\n        </Container>\r\n        </FormProvider>\r\n\r\n\r\n    );\r\n}"]},"metadata":{},"sourceType":"module"}